<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OP-XY Multisample Converter</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>OP-XY Multisample Converter</h1>
            <p class="subtitle">Convert multisamples to OP-XY format with automatic silence trimming</p>
        </header>

        <main>
            <div class="mode-selector">
                <h2>Choose Conversion Mode</h2>
                <div class="mode-buttons">
                    <button id="elektron-mode-btn" class="mode-btn active" onclick="switchMode('elektron')">
                        <strong>Elektron Mode</strong>
                        <span>.elmulti + .wav files</span>
                    </button>
                    <button id="folder-mode-btn" class="mode-btn" onclick="switchMode('folder')">
                        <strong>Folder Mode</strong>
                        <span>Individual WAV files</span>
                    </button>
                </div>
            </div>

            <!-- Elektron Mode -->
            <div id="elektron-mode" class="mode-panel active">
                <h3>Elektron Mode</h3>
                <p>Upload an Elektron .elmulti file and its corresponding .wav file</p>

                <div class="file-input-group">
                    <label for="elmulti-file">
                        <strong>.elmulti file:</strong>
                        <input type="file" id="elmulti-file" accept=".elmulti" onchange="handleElmultiFile(event)">
                    </label>
                    <span id="elmulti-filename" class="filename"></span>
                </div>

                <div class="file-input-group">
                    <label for="wav-file">
                        <strong>.wav file:</strong>
                        <input type="file" id="wav-file" accept=".wav" onchange="handleWavFile(event)">
                    </label>
                    <span id="wav-filename" class="filename"></span>
                </div>

                <button id="convert-elektron-btn" class="convert-btn" onclick="convertElektron()" disabled>
                    Convert to OP-XY Format
                </button>
            </div>

            <!-- Folder Mode -->
            <div id="folder-mode" class="mode-panel">
                <h3>Folder Mode</h3>
                <p>Upload multiple WAV files with note names in filenames (e.g., "Piano C3.wav")</p>

                <div class="file-input-group">
                    <label for="preset-name">
                        <strong>Preset Name:</strong>
                        <input type="text" id="preset-name" placeholder="MyPreset" onchange="updateConvertButton()">
                    </label>
                </div>

                <div class="file-input-group">
                    <label for="wav-files">
                        <strong>Select WAV files:</strong>
                        <input type="file" id="wav-files" accept=".wav" multiple onchange="handleWavFiles(event)">
                    </label>
                    <span id="wav-files-count" class="filename"></span>
                </div>

                <button id="convert-folder-btn" class="convert-btn" onclick="convertFolder()" disabled>
                    Convert to OP-XY Format
                </button>
            </div>

            <!-- Progress and Log -->
            <div id="progress-section" class="hidden">
                <h3>Processing...</h3>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="log-output" class="log-output"></div>
            </div>

            <!-- Waveform Editor -->
            <div id="waveform-section" class="hidden">
                <h3>Edit Sample Points</h3>
                <div class="sample-selector">
                    <button id="prev-sample-btn" onclick="prevSample()" disabled>‚Üê Previous</button>
                    <span id="current-sample-info">Sample 1 of 1</span>
                    <button id="next-sample-btn" onclick="nextSample()" disabled>Next ‚Üí</button>
                </div>

                <div class="waveform-container">
                    <canvas id="waveform-canvas"></canvas>
                    <div id="waveform-markers"></div>
                </div>

                <div class="waveform-controls">
                    <div class="control-group">
                        <button onclick="playPreview()">‚ñ∂ Play</button>
                        <button onclick="stopPreview()">‚èπ Stop</button>
                        <button onclick="zoomIn()">üîç+</button>
                        <button onclick="zoomOut()">üîç-</button>
                        <button onclick="resetZoom()">Reset Zoom</button>
                        <button onclick="resetToInitial()" style="background: #ef4444;">Reset to Initial</button>
                    </div>

                    <div class="marker-values">
                        <div class="marker-value">
                            <label>In Point:</label>
                            <input type="number" id="in-point-value" min="0" onchange="updateMarkerFromInput('in')">
                            <span class="time-display" id="in-point-time">0.000s</span>
                            <button class="apply-all-btn" onclick="applyToAll('in')" title="Apply this In Point to all samples">Apply to All</button>
                        </div>
                        <div class="marker-value">
                            <label>Out Point:</label>
                            <input type="number" id="out-point-value" min="0" onchange="updateMarkerFromInput('out')">
                            <span class="time-display" id="out-point-time">0.000s</span>
                            <button class="apply-all-btn" onclick="applyToAll('out')" title="Apply this Out Point to all samples">Apply to All</button>
                        </div>
                        <div class="marker-value">
                            <label>Loop Start:</label>
                            <input type="number" id="loop-start-value" min="0" onchange="updateMarkerFromInput('loopStart')">
                            <span class="time-display" id="loop-start-time">0.000s</span>
                            <button class="apply-all-btn" onclick="applyToAll('loopStart')" title="Apply this Loop Start to all samples">Apply to All</button>
                        </div>
                        <div class="marker-value">
                            <label>Loop End:</label>
                            <input type="number" id="loop-end-value" min="0" onchange="updateMarkerFromInput('loopEnd')">
                            <span class="time-display" id="loop-end-time">0.000s</span>
                            <button class="apply-all-btn" onclick="applyToAll('loopEnd')" title="Apply this Loop End to all samples">Apply to All</button>
                        </div>
                    </div>

                    <div class="playback-settings">
                        <h4>Playback Settings</h4>
                        <div class="setting-row">
                            <label>
                                <input type="checkbox" id="reverse-playback" onchange="updatePlaybackSettings()">
                                Reverse Playback
                            </label>
                            <button class="apply-all-btn" onclick="applyPlaybackToAll('reverse')" title="Apply reverse setting to all samples">Apply to All</button>
                        </div>
                        <div class="setting-row">
                            <label for="loop-crossfade">Loop Crossfade (frames):</label>
                            <input type="number" id="loop-crossfade" min="0" max="10000" value="0" onchange="updatePlaybackSettings()">
                            <button class="apply-all-btn" onclick="applyPlaybackToAll('crossfade')" title="Apply crossfade setting to all samples">Apply to All</button>
                            <div class="creative-controls">
                                <button class="creative-btn" onclick="applyGradient('crossfade', 'linear')" title="Fade from low to high">‚Üó Fade In</button>
                                <button class="creative-btn" onclick="applyGradient('crossfade', 'reverse')" title="Fade from high to low">‚Üò Fade Out</button>
                                <button class="creative-btn" onclick="applyGradient('crossfade', 'exp')" title="Exponential curve">üìà Curve</button>
                                <button class="creative-btn" onclick="randomizeAll('crossfade')" title="Random variation">üé≤ Random</button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <label for="sample-gain">Gain (dB):</label>
                            <input type="number" id="sample-gain" min="-60" max="12" step="0.1" value="0" onchange="updatePlaybackSettings()">
                            <span class="setting-value" id="gain-display">0.0 dB</span>
                            <button class="apply-all-btn" onclick="applyPlaybackToAll('gain')" title="Apply gain setting to all samples">Apply to All</button>
                            <div class="creative-controls">
                                <button class="creative-btn" onclick="applyGradient('gain', 'linear')" title="Fade from quiet to loud">‚Üó Fade In</button>
                                <button class="creative-btn" onclick="applyGradient('gain', 'reverse')" title="Fade from loud to quiet">‚Üò Fade Out</button>
                                <button class="creative-btn" onclick="applyGradient('gain', 'exp')" title="Exponential curve">üìà Curve</button>
                                <button class="creative-btn" onclick="randomizeAll('gain')" title="Random variation">üé≤ Random</button>
                            </div>
                        </div>
                        <div class="setting-row">
                            <label for="sample-tune">Tune (cents):</label>
                            <input type="number" id="sample-tune" min="-100" max="100" value="0" onchange="updatePlaybackSettings()">
                            <span class="setting-value" id="tune-display">0 cents</span>
                            <button class="apply-all-btn" onclick="applyPlaybackToAll('tune')" title="Apply tuning to all samples">Apply to All</button>
                            <div class="creative-controls">
                                <button class="creative-btn" onclick="applyGradient('tune', 'linear')" title="Detune up progressively">‚Üó Detune Up</button>
                                <button class="creative-btn" onclick="applyGradient('tune', 'reverse')" title="Detune down progressively">‚Üò Detune Down</button>
                                <button class="creative-btn" onclick="applyGradient('tune', 'wave')" title="Wave pattern">„Ä∞ Wave</button>
                                <button class="creative-btn" onclick="randomizeAll('tune')" title="Random variation">üé≤ Random</button>
                            </div>
                        </div>
                    </div>

                    <div class="playback-settings" style="background: #fef3c7; border: 2px solid #f59e0b;">
                        <h4 style="color: #d97706;">üéµ Steve Reich Phasing</h4>
                        <p style="font-size: 0.85em; color: #92400e; margin-bottom: 12px;">Create gradually shifting loop points across samples for minimalist phasing effects</p>
                        <div class="creative-controls">
                            <button class="creative-btn" onclick="applyReichPhasing('subtle')" style="background: #f59e0b;" title="Subtle phase shift">Subtle Phase</button>
                            <button class="creative-btn" onclick="applyReichPhasing('moderate')" style="background: #d97706;" title="Moderate phase shift">Moderate Phase</button>
                            <button class="creative-btn" onclick="applyReichPhasing('extreme')" style="background: #b45309;" title="Extreme phase shift">Extreme Phase</button>
                            <button class="creative-btn" onclick="applyReichPhasing('poly')" style="background: #92400e;" title="Polyrhythmic phasing">Polyrhythmic</button>
                        </div>
                    </div>

                    <button class="convert-btn" onclick="finalizeConversion()">Finalize All Samples</button>
                </div>
            </div>

            <!-- Download Section -->
            <div id="download-section" class="hidden">
                <h3>‚úì Conversion Complete!</h3>
                <p>Your preset is ready to download</p>
                <button id="download-btn" class="download-btn" onclick="downloadPreset()">
                    Download .preset folder (ZIP)
                </button>
                <button class="download-btn" onclick="downloadPatchJson()" style="background: #8b5cf6; margin-top: 10px;">
                    Download patch.json Only (for debugging)
                </button>
                <p class="instruction">Extract the ZIP and copy the .preset folder to /TAPE/multisamples/ on your OP-XY</p>
            </div>
        </main>

        <footer>
            <details>
                <summary>File Naming Guide for Folder Mode</summary>
                <div class="info-box">
                    <p><strong>Supported formats:</strong></p>
                    <ul>
                        <li><code>Piano C3.wav</code></li>
                        <li><code>C3.wav</code></li>
                        <li><code>piano_C#3.wav</code></li>
                        <li><code>Bass_Db3.wav</code></li>
                        <li><code>SampleName D-1.wav</code> (negative octaves supported)</li>
                    </ul>
                    <p>The tool extracts note names from filenames and creates proper key mappings.</p>
                </div>
            </details>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="converter.js"></script>
</body>
</html>
